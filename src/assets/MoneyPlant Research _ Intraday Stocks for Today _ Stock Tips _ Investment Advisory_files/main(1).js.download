"use strict";var WebSocketClient=function(){let socket;let channels=[];let connected=false;let tokensManager;let subscribe=function(channel,callback,tokenObject){let channelData={channel:channel,tokenObject:tokenObject,callback:callback};channels.push(channelData);subscribeRequest(channelData);};let subscribeRequest=function(chanelData){if(!connected){return;}
let channel=chanelData.channel;let tokenObject=chanelData.tokenObject;let callback=chanelData.callback;if(!isGlobalChannel(channel)){let expirationDate=new Date(tokenObject.expirationDate);if(expirationDate<new Date()){return;}}
let token=tokenObject?tokenObject.token:"";socket.emit("subscribe",{channel:channel,token:token},(response)=>{});socket.on(channel,function(data){if(typeof data!=="object"){callback(JSON.parse(data));}
else{callback(data);}});};let resubscribeToChannels=function(){channels.forEach((channelData)=>{subscribeRequest(channelData);});};let isGlobalChannel=function(channel){return channel.startsWith("global");};let onDisconnect=function(){channels.forEach((channelData)=>{socket.off(channelData.channel);});connected=false;};return{subscribeToGlobalChannel:function(channel,id,callback){if(isGlobalChannel(channel)){subscribe(channel+id,callback);}},subscribeToPrivateChannel:function(channel,id,onEventCallback){tokensManager.getToken(channel,id).then(function(tokenObject){subscribe(channel+id,onEventCallback,tokenObject);});},init:function(url,tokenFunc,lang,options){tokensManager=new TokenManager(tokenFunc);socket=io(url,Object.assign({transports:["websocket","polling"],query:{lang:lang}},options));socket.lang=lang;socket.on("connect",()=>{connected=true;resubscribeToChannels();});socket.on("disconnect",()=>{onDisconnect();});}};}();function TokenManager(tokenFunction){let tokens={};this.getToken=function(channel,id){return new Promise((resolve,reject)=>{let fullChannelName=this.channelFullName(channel,id);let tokenObject=tokens[fullChannelName];if(tokenObject&&this.validToken(tokenObject)){resolve(tokenObject);}
else{tokenFunction(channel,id,function(tokenObject){if(tokenObject&&tokenObject.token){tokens[fullChannelName]=tokenObject;resolve(tokenObject);}});}});};this.channelFullName=function(channel,id){let fullChannelName=channel;if(id){fullChannelName+=id;}
return fullChannelName;};this.validToken=function(tokenObject){let expirationDate=new Date(tokenObject.expirationDate);if(expirationDate>new Date()){return true;}
return false;};}